const malla = {
  // ... Tu estructura de malla está perfecta y no necesita cambios ...
  // (La dejo fuera para que no se repita todo, solo pega la parte que ya tienes aquí)
};

let estado = JSON.parse(localStorage.getItem('mallaEstado')) || {};

function guardarEstado() {
  localStorage.setItem('mallaEstado', JSON.stringify(estado));
}

function crearTarjeta(ramo) {
  const div = document.createElement('div');
  div.id = ramo.id;
  div.textContent = ramo.nombre;
  div.classList.add('ramo');

  if (estado[ramo.id]) {
    div.classList.add('aprobado');
  } else if (puedeDesbloquear(ramo)) {
    div.classList.add('desbloqueado');
    div.addEventListener('click', () => {
      aprobarRamo(ramo.id);
    });
  } else {
    div.classList.add('bloqueado');
  }

  return div;
}

function puedeDesbloquear(ramo) {
  return ramo.prereq.every(pr => estado[pr]);
}

function aprobarRamo(id) {
  estado[id] = true;
  guardarEstado();
  actualizarMalla();
}

function actualizarMalla() {
  const container = document.getElementById('malla-container');
  container.innerHTML = '';

  // Agrupar los semestres por año
  const agrupadoPorAno = {};

  for (const semestre in malla) {
    const [ano, nombreSemestre] = semestre.split(' - ');
    if (!agrupadoPorAno[ano]) agrupadoPorAno[ano] = [];
    agrupadoPorAno[ano].push({
      nombre: nombreSemestre,
      ramos: malla[semestre]
    });
  }

  // Crear la estructura visual
  for (const ano in agrupadoPorAno) {
    const divAno = document.createElement('div');
    divAno.classList.add('ano');

    const tituloAno = document.createElement('h2');
    tituloAno.textContent = ano;
    divAno.appendChild(tituloAno);

    const contenedorSemestres = document.createElement('div');
    contenedorSemestres.classList.add('columnas-semestres');

    agrupadoPorAno[ano].forEach(semestre => {
      const divSemestre = document.createElement('div');
      divSemestre.classList.add('semestre');

      const tituloSemestre = document.createElement('h3');
      tituloSemestre.textContent = semestre.nombre;
      divSemestre.appendChild(tituloSemestre);

      semestre.ramos.forEach(ramo => {
        const tarjeta = crearTarjeta(ramo);
        divSemestre.appendChild(tarjeta);
      });

      contenedorSemestres.appendChild(divSemestre);
    });

    divAno.appendChild(contenedorSemestres);
    container.appendChild(divAno);
  }

  actualizarBarraProgreso();
}

function actualizarBarraProgreso() {
  let total = 0;
  let aprobados = 0;

  for (const semestre in malla) {
    malla[semestre].forEach(ramo => {
      total++;
      if (estado[ramo.id]) aprobados++;
    });
  }

  const porcentaje = total > 0 ? Math.round((aprobados / total) * 100) : 0;
  const barra = document.getElementById('barra');
  barra.style.width = porcentaje + '%';
  barra.textContent = porcentaje + '%';
}

function reiniciarMalla() {
  localStorage.removeItem('mallaEstado');
  estado = {};
  actualizarMalla();
}

document.getElementById('btnReiniciar').addEventListener('click', reiniciarMalla);

actualizarMalla();
